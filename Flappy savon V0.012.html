<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flappy Savon ‚Äì Concours & D√©cor ++</title>
  <style>
    :root{
      --bg1:#0a1016; --bg2:#0e1722;
      --ink:#e6e6e6; --accent:#42b883; --panel:#0b111acc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{display:grid;place-items:center;min-height:100vh;padding:24px}
    canvas{background:transparent;border:2px solid #1b2838;border-radius:16px;box-shadow:0 16px 48px #000c;touch-action:none;width:min(92vw,420px);height:auto}

    .hud{position:fixed;inset:auto 0 16px 0;display:flex;justify-content:center;pointer-events:none}
    .panel{display:flex;flex-wrap:wrap;gap:8px 12px;background:var(--panel);padding:10px 14px;border-radius:12px;backdrop-filter:blur(6px);border:1px solid #1f2633}
    .stat{font-variant-numeric:tabular-nums}
    .btn{pointer-events:auto;border:0;border-radius:10px;padding:8px 10px;font-weight:700;background:var(--accent);color:#062216;cursor:pointer}
    .btn.secondary{background:#263238;color:#e0e0e0}
    .btn.icon{width:40px;display:grid;place-items:center;padding:8px}
    .title{position:fixed;top:10px;left:50%;transform:translateX(-50%);font-weight:800;letter-spacing:.5px;opacity:.9}

    /* Bandeau concours */
    .contest{position:fixed;top:44px;left:50%;transform:translateX(-50%);display:flex;gap:10px;align-items:center;background:#0e131b;border:1px solid #1f2633;border-radius:12px;padding:8px 12px;box-shadow:0 10px 26px #000a}
    .contest .goal{font-weight:700}
    .contest .count{font-variant-numeric:tabular-nums;opacity:.9}

    /* Modal g√©n√©rique */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0008;backdrop-filter:blur(4px);z-index:50}
    .modal.open{display:flex}
    .card{background:#0e131b;border:1px solid #1f2633;border-radius:14px;padding:16px;min-width:280px;max-width:min(92vw,460px);box-shadow:0 10px 30px #000a}
    .card h2{margin:0 0 8px;font-size:18px}
    .row{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .row.inline{flex-direction:row;align-items:center;gap:10px}
    .row label{font-size:13px;opacity:.9}
    .row input[type="text"], .row input[type="email"]{padding:10px;border-radius:10px;border:1px solid #2a3342;background:#0b1017;color:#eaeef2}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .note{font-size:12px;opacity:.8;margin-top:4px}
    .cta{display:flex;gap:8px;align-items:center;justify-content:flex-end}

    /* Leaderboard */
    .leader{position:fixed;top:108px;right:16px;background:#0e131b;border:1px solid #1f2633;border-radius:12px;padding:10px;min-width:260px;max-height:70vh;overflow:auto;box-shadow:0 10px 26px #000a;display:none}
    .leader h3{margin:0 0 8px;font-size:16px}
    .lb-row{display:grid;grid-template-columns:32px 1fr auto;gap:8px;padding:6px 4px;border-bottom:1px dashed #1f2633;align-items:center}
    .lb-row:last-child{border-bottom:0}
    .lb-row.top1{background:linear-gradient(90deg, #0000, #0002); outline:1px solid #4d3; border-radius:8px}
    .medal{font-size:16px}
    .muted{opacity:.75;font-size:12px}

    /* Rank bubbles */
    .rank{position:fixed;top:10px;right:10px;background:#0b111acc;border:1px solid #1f2633;border-radius:999px;padding:6px 10px;font-size:12px;box-shadow:0 6px 18px #000a;display:none}
    .rank.good{outline:2px solid #42b883}
    #rankLive{top:10px;left:10px;right:auto}
    #rankLive.guest{opacity:.75}

    /* Toast */
    .toast{position:fixed;bottom:88px;left:50%;transform:translateX(-50%);background:#0b111acc;border:1px solid #1f2633;border-radius:10px;padding:8px 12px;font-size:13px;opacity:0;transition:opacity .25s, transform .25s;pointer-events:none}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

    /* Skins */
    .skins{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .swatch{border-radius:10px;border:1px solid #1f2633;padding:10px;cursor:pointer;display:flex;align-items:center;gap:8px}
    .swatch .dot{width:18px;height:18px;border-radius:50%}

    /* Lot visuel */
    .prize{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b111acc;border:1px solid #1f2633;border-radius:12px;padding:10px 12px;display:none;align-items:center;gap:10px;box-shadow:0 10px 26px #000a;z-index:40}
    .prize img{width:56px;height:56px;object-fit:contain}
    .prize .txt{font-size:14px}

    /* Rappel invit√© */
    .reminder{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);display:none;gap:8px;align-items:center;background:#0b111acc;border:1px solid #1f2633;border-radius:12px;padding:8px 12px;box-shadow:0 10px 26px #000a;z-index:41}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="420" height="700" aria-label="Flappy Savon ‚Äì Savon Yvard"></canvas>
    <div class="title">Flappy Savon</div>

    <!-- Bandeau concours -->
    <div class="contest" id="contest">
      <div class="goal">üéØ Objectif : entrer dans le Top 3</div>
      <div class="count" id="countdown">Fin dans ‚Äî:‚Äî:‚Äî</div>
    </div>

    <div class="hud">
      <div class="panel">
        <div>Score: <span id="score" class="stat">0</span></div>
        <div>Meilleur: <span id="best" class="stat">0</span></div>
        <div>Points: <span id="points" class="stat">0</span></div>
        <button id="leaderBtn" class="btn secondary">Classement</button>
        <button id="skinBtn" class="btn secondary">Skins</button>
        <button id="idBtn" class="btn secondary">Mon compte</button>
        <button id="muteBtn" class="btn icon" title="Son on/off">üîà</button>
        <button id="shareBtn" class="btn secondary">Partager</button>
        <button id="restart" class="btn">Rejouer</button>
      </div>
    </div>
  </div>

  <!-- Rank bubbles -->
  <div id="rank" class="rank">Rang ‚Äî</div>
  <div id="rankLive" class="rank" style="display:none">Rang¬†‚Äî</div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Rappel invit√© -->
  <div id="reminder" class="reminder">
    <span>Entrez vos infos pour entrer au classement</span>
    <button id="reminderBtn" class="btn">Mon compte</button>
  </div>

  <!-- Modal identit√© / Onboarding -->
  <div id="idModal" class="modal" aria-hidden="true">
    <div class="card">
      <h2>Bienvenue dans Flappy Savon Yvard ü´ß</h2>
      <p class="muted">Pour participer au <strong>concours Top 3</strong> et appara√Ætre au classement, entre ton pseudo et ton e‚Äëmail (facultatif pour jouer, requis pour le compte).</p>
      <div class="row">
        <label for="pseudo">Pseudo</label>
        <input id="pseudo" type="text" placeholder="SavonMaster" maxlength="24" />
      </div>
      <div class="row">
        <label for="email">E‚Äëmail</label>
        <input id="email" type="email" placeholder="toi@exemple.fr" />
      </div>
      <div class="row inline">
        <input id="optin" type="checkbox" />
        <label for="optin" style="margin:0">J‚Äôaccepte de recevoir des e‚Äëmails de Savon Yvard dans le cadre du concours et d‚Äôoffres sp√©ciales.</label>
      </div>
      <div class="note">Vos donn√©es sont utilis√©es conform√©ment √† notre <a href="https://savon-yvard.fr/politique-de-confidentialite/" target="_blank" rel="noopener">politique de confidentialit√©</a>. Vous pouvez retirer votre consentement √† tout moment.</div>
      <div class="actions cta">
        <button id="idSave" class="btn secondary">Enregistrer</button>
        <button id="idStart" class="btn">Commencer √† jouer</button>
      </div>
    </div>
  </div>

  <!-- Modal skins -->
  <div id="skinModal" class="modal" aria-hidden="true">
    <div class="card">
      <h2>Choisis ton savon</h2>
      <p class="muted">Skins inspir√©s de ta gamme (couleurs indicatives).</p>
      <div class="skins" id="skins"></div>
      <div class="actions">
        <button id="skinClose" class="btn">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div id="leader" class="leader">
    <h3>Top 10 (concours)</h3>
    <div id="leaderRows"></div>
    <div class="muted" id="leaderMeta"></div>
  </div>

  <!-- Prize popup -->
  <div id="prize" class="prize">
    <img id="prizeImg" alt="Lot" />
    <div class="txt" id="prizeTxt"></div>
  </div>

  <script>
  // ====== Config concours & API ======
  const CONTEST_END = '2025-09-15T23:59:59+02:00'; // Europe/Paris
  const API_BASE = 'https://n8n.miisteurniko.fr/webhook';
  const ENDPOINT_SCORE = API_BASE + '/flappy-score';
  const ENDPOINT_LEADER = API_BASE + '/flappy-leaderboard';

  // Obstacles via image (laisser vide pour dessin kraft)
  const OBSTACLE_IMG_URL = '';
  const prizeImgs = { 1: '', 2: '', 3: '' };

  // ====== Setup jeu ======
  const cvs = document.getElementById('game');
  const cx = cvs.getContext('2d');
  const W = cvs.width, H = cvs.height;
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const pointsEl = document.getElementById('points');
  const restartBtn = document.getElementById('restart');
  const leaderBtn = document.getElementById('leaderBtn');
  const idBtn = document.getElementById('idBtn');
  const skinBtn = document.getElementById('skinBtn');
  const muteBtn = document.getElementById('muteBtn');
  const shareBtn = document.getElementById('shareBtn');
  const countdownEl = document.getElementById('countdown');
  const contest = document.getElementById('contest');
  const rankBubble = document.getElementById('rank');
  const rankLive = document.getElementById('rankLive');
  const toastEl = document.getElementById('toast');
  const prizeBox = document.getElementById('prize');
  const prizeImg = document.getElementById('prizeImg');
  const prizeTxt = document.getElementById('prizeTxt');
  const reminder = document.getElementById('reminder');
  const reminderBtn = document.getElementById('reminderBtn');

  const idModal = document.getElementById('idModal');
  const pseudoInput = document.getElementById('pseudo');
  const emailInput = document.getElementById('email');
  const optinInput = document.getElementById('optin');
  const idSave = document.getElementById('idSave');
  const idStart = document.getElementById('idStart');

  const skinModal = document.getElementById('skinModal');
  const skinsEl = document.getElementById('skins');
  const skinClose = document.getElementById('skinClose');

  const leader = document.getElementById('leader');
  const leaderRows = document.getElementById('leaderRows');
  const leaderMeta = document.getElementById('leaderMeta');

  // Physique & constantes
  const GRAV = 0.45, FLAP = -8.5, PIPE_GAP = 150, PIPE_W = 70, PIPE_SPACING = 220, GROUND_H = 90, SCROLL = 2.25;
  const soap = { x:100, y:H*0.5, vx:0, vy:0, w:66, h:38, rot:0, img:null };

  // ====== Th√®mes / D√©cors dynamiques ======
  const THEMES = [
    { id:'carrelage',  from:0,   bg1:'#0b1a26', bg2:'#10283a', grid:'rgba(20,52,72,0.35)', fog:0, leaves:6, bubbleMul:1 },
    { id:'hammam',     from:10,  bg1:'#0d141b', bg2:'#152635', grid:'rgba(170,210,230,0.15)', fog:1, leaves:4, bubbleMul:1.4 },
    { id:'atelier',    from:25,  bg1:'#0f1714', bg2:'#1d2a22', grid:'rgba(30,60,50,0.28)',   fog:0, leaves:8, bubbleMul:0.9 }
  ];
  function themeForScore(s){ let t=THEMES[0]; for(const th of THEMES){ if(s>=th.from) t=th; } return t; }
  let currentTheme = THEMES[0];
  let prevTheme = THEMES[0];
  let themeTrans = 0; // 0..1
  const steam = []; // particules vapeur pour hammam

  // D√©cor & effets
  const bubbles = []; const leaves = []; let gridOffset = 0; const confetti = [];

  let pipes = [], t = 0, alive = false, gameOver = false, score = 0;
  let totalPoints = Number(localStorage.getItem('flappySavonPoints')||0);
  let best = Number(localStorage.getItem('flappySavonBest')||0);
  let gamesPlayed = Number(localStorage.getItem('flappySavonGames')||0);
  let gameStartMs = performance.now();
  let lastLeaderboard = null; // cache
  let sessionSeed = Math.random().toString(36).slice(2);

  bestEl.textContent = best; pointsEl.textContent = totalPoints;

  // ====== Audio ======
  let audioCtx = null, muted = localStorage.getItem('flappySavonMuted')==='1';
  function ensureAudio(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch{} } }
  function tone(freq, dur=0.08, type='sine', gain=0.03){ if(muted||!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audioCtx.destination); const t=audioCtx.currentTime; o.start(t); o.stop(t+dur); }
  const sfx = { flap(){ tone(880,0.05,'square',0.035); }, score(){ tone(660,0.06,'sine',0.045); setTimeout(()=>tone(990,0.06,'sine',0.04),60); }, hit(){ tone(120,0.15,'sawtooth',0.05); } };
  function toggleMute(){ muted=!muted; localStorage.setItem('flappySavonMuted', muted?'1':'0'); muteBtn.textContent = muted?'üîá':'üîà'; showToast(muted?'Son coup√©':'Son activ√©'); }
  muteBtn.textContent = muted?'üîá':'üîà';

  // ====== Skins ======
  const SKINS = [
  { id:'ortie',  name:"Poudre d'Ortie", c1:'#cfe8c8', c2:'#84c17a' },
  { id:'monoi',  name:'Mono√Ø',           c1:'#fff0d5', c2:'#ffd19a' },
  { id:'citron', name:'Citron Gingembre',c1:'#ffd6a3', c2:'#ffab40' },
  { id:'lait',   name:"Lait d‚Äô√¢nesse",   c1:'#f9fbff', c2:'#e2e8f0' },
  { id:'safran', name:'Safran',          c1:'#ffe7a8', c2:'#f6b340' },
  { id:'cedre',  name:'C√®dre du Liban',  c1:'#c7b299', c2:'#8e6e53' },
  { id:'noir',   name:'Savon noir',      c1:'#222629', c2:'#0b0f12' }
];
  let skinId = localStorage.getItem('flappySavonSkin') || 'ortie';
  if(localStorage.getItem('flappySavonSkin') === 'coton'){ localStorage.setItem('flappySavonSkin','ortie'); skinId = 'ortie'; }
  function openSkins(){ skinsEl.innerHTML=''; SKINS.forEach(s=>{ const el=document.createElement('div'); el.className='swatch'; el.innerHTML='<div class="dot" style="background:linear-gradient(45deg,'+s.c1+','+s.c2+')"></div><div>'+s.name+'</div>'; el.onclick=()=>{ skinId=s.id; localStorage.setItem('flappySavonSkin', skinId); showToast('Skin: '+s.name); closeSkins(); }; skinsEl.appendChild(el); }); skinModal.classList.add('open'); }
  function closeSkins(){ skinModal.classList.remove('open'); }
  skinBtn.addEventListener('click', openSkins); skinClose.addEventListener('click', closeSkins);

  // ====== Helpers UI ======
  function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=>toastEl.classList.remove('show'), 1700); }
  function showRank(r){ if(!r) return; rankBubble.textContent = 'Rang '+r+(r<=3?' ‚Äì bravo!':''); rankBubble.classList.toggle('good', r<=3); rankBubble.style.display='block'; clearTimeout(showRank._t); showRank._t = setTimeout(()=> rankBubble.style.display='none', 2600); }
  function setLiveRank(r, guest){ if(!r) return; rankLive.textContent = 'Rang '+r; rankLive.classList.toggle('guest', !!guest); rankLive.style.display = 'block'; }

  // ====== Game core ======
  function reset(){
    pipes.length = 0; t = 0; score = 0; alive = false; gameOver=false; gameStartMs = performance.now();
    soap.x = 100; soap.y = H*0.5; soap.vx = 0; soap.vy = 0; soap.rot = 0;
    for(let i=0;i<4;i++) addPipe(W + i*PIPE_SPACING);
    // d√©cor initial (moins de bulles par d√©faut)
    bubbles.length = 0; for(let i=0;i<10;i++) spawnBubble(Math.random()*W, Math.random()*H);
    leaves.length = 0; for(let i=0;i<6;i++) spawnLeaf(W+Math.random()*W);
    steam.length = 0; confetti.length = 0;
    currentTheme = themeForScore(0); prevTheme=currentTheme; themeTrans=1;
    scoreEl.textContent = score;
    if(contest) contest.style.display = 'flex';
    leader.style.display = 'none';
    prizeBox.style.display = 'none';
  }

  function addPipe(x){ const margin = 60; const topH = Math.max(margin, Math.min(H - GROUND_H - margin - PIPE_GAP, rand(margin, H - GROUND_H - margin - PIPE_GAP))); const bottomY = topH + PIPE_GAP; pipes.push({ x, topH, bottomY, passed:false }); }
  const rand=(a,b)=>Math.random()*(b-a)+a;

  function flap(){ ensureAudio(); if(gameOver){ reset(); return; } alive = true; soap.vy = FLAP; splash(soap.x, soap.y); sfx.flap(); if(contest) contest.style.display = 'none'; leader.style.display = 'none'; }

  window.addEventListener('keydown', (e)=>{ if(e.code==='Space'||e.key==='ArrowUp'){ e.preventDefault(); flap(); }});
  cvs.addEventListener('pointerdown', (e)=>{ e.preventDefault(); flap(); });
  restartBtn.addEventListener('click', ()=> reset());
  idBtn.addEventListener('click', ()=> openIdentityModal());
  leaderBtn.addEventListener('click', async ()=>{ leader.style.display = leader.style.display==='none' ? 'block' : 'none'; if(leader.style.display==='block') await loadLeaderboard(); });
  muteBtn.addEventListener('click', toggleMute);
  shareBtn.addEventListener('click', shareScore);
  reminderBtn.addEventListener('click', ()=>{ reminder.style.display='none'; openIdentityModal(); });

  let last = 0; function loop(ms){ const dt = Math.min(32, ms - last || 16); last = ms; update(dt/16); draw(); requestAnimationFrame(loop); }

  function update(dt){
    // th√©matisation en fonction du score (transition douce)
    const nextTheme = themeForScore(score);
    if(nextTheme.id !== currentTheme.id){ prevTheme = currentTheme; currentTheme = nextTheme; themeTrans = 0; }
    if(themeTrans < 1) themeTrans = Math.min(1, themeTrans + 0.02*dt);

    gridOffset += 0.15 * dt; if(gridOffset > 32) gridOffset -= 32;

    // bulles
    for(const b of bubbles){ b.y -= b.vy*dt; b.x += Math.sin((b.y+b.r)*0.02)*0.2; b.alpha -= 0.0008*dt; if(b.y < -20 || b.alpha <= 0){ b.x=rand(0,W); b.y=H - GROUND_H - rand(10,90); b.alpha=rand(0.2,0.6);} }

    // feuilles
    for(const f of leaves){ f.x -= f.vx*dt; f.y += f.vy*dt; f.rot += 0.01*dt; if(f.x < -50) Object.assign(f, spawnLeaf(W+rand(0,200), true)); }

    // vapeur hammam
    if(currentTheme.fog){ if(steam.length<14) spawnSteam(); for(let i=steam.length-1;i>=0;i--){ const s=steam[i]; s.y-=s.v*dt; s.x+=Math.sin((t+s.seed)*0.05)*0.2; s.a-=0.0015*dt; if(s.a<=0||s.y<-30) steam.splice(i,1); } } else { steam.length=0; }

    // confettis
    for(let i=confetti.length-1;i>=0;i--){ const c=confetti[i]; c.x+=c.vx*dt; c.y+=c.vy*dt; c.vy+=0.05*dt; c.life-=dt; if(c.life<=0) confetti.splice(i,1); }

    if(!gameOver){
      for(let p of pipes){ p.x -= SCROLL*dt; }
      if(pipes.length && pipes[0].x + PIPE_W < 0){ pipes.shift(); addPipe(pipes[pipes.length-1].x + PIPE_SPACING); }
      if(alive){ soap.vy += GRAV*dt; soap.y += soap.vy*dt; soap.rot = Math.atan2(soap.vy, 8); }
      if(soap.y + soap.h/2 > H - GROUND_H + 6){ soap.y = H - GROUND_H - soap.h/2 + 6; dead(); }
      if(soap.y - soap.h/2 < 0){ soap.y = soap.h/2; soap.vy = 0; }
      for(const p of pipes){
        if(!p.passed && p.x + PIPE_W < soap.x){
          p.passed = true; score++; scoreEl.textContent = score; totalPoints += 10; pointsEl.textContent = totalPoints; splash(soap.x, soap.y); sfx.score();
          checkBadges(score);
          if(lastLeaderboard){ const r = computeRank(lastLeaderboard); const isGuest = !localStorage.getItem('email'); if(r) setLiveRank(r, isGuest); }
          // Ajuste densit√© d√©cor selon th√®me
          adjustAmbientByTheme(currentTheme);
        }
        const sx1 = soap.x - soap.w/2 + 8, sx2 = soap.x + soap.w/2 - 8; const sy1 = soap.y - soap.h/2 + 6, sy2 = soap.y + soap.h/2 - 6;
        const topRect = {x:p.x, y:0, w:PIPE_W, h:p.topH}; const bottomRect = {x:p.x, y:p.bottomY, w:PIPE_W, h:H - GROUND_H - p.bottomY};
        if(intersectAABB(sx1,sy1,sx2,sy2, topRect.x,topRect.y, topRect.x+topRect.w, topRect.y+topRect.h) || intersectAABB(sx1,sy1,sx2,sy2, bottomRect.x,bottomRect.y, bottomRect.x+bottomRect.w, bottomRect.y+bottomRect.h)) dead();
      }
    }
  }

  function dead(){
    if(gameOver) return; gameOver = true; alive=false; sfx.hit();
    best = Math.max(best, score); localStorage.setItem('flappySavonBest', String(best)); localStorage.setItem('flappySavonPoints', String(totalPoints)); bestEl.textContent = best; pointsEl.textContent = totalPoints;
    if(contest) contest.style.display = 'flex';
    leader.style.display = 'none';
    gamesPlayed++; localStorage.setItem('flappySavonGames', String(gamesPlayed));
    const hasEmail = !!(localStorage.getItem('email'));
    if(!hasEmail && gamesPlayed>=2){ reminder.style.display='flex'; }
    postScore().then(()=> loadLeaderboard().then((rows)=>{ const r = computeRank(rows); if(r) { setLiveRank(r, !hasEmail); showRank(r); showPrize(r); } }).catch(()=>{})).catch(()=>{});
  }

  const intersectAABB=(ax1,ay1,ax2,ay2,bx1,by1,bx2,by2)=> ax1<bx2 && ax2>bx1 && ay1<by2 && ay2>by1;

  // ====== Rendu ======
  function draw(){
    cx.clearRect(0,0,W,H);
    drawBackground();
    drawPipes();
    drawFoamGround();
    drawLeaves();
    drawBubbles();
    drawSteam();
    drawConfetti();
    drawSoap(soap.x,soap.y,soap.w,soap.h,soap.rot);
    if(!alive && !gameOver) drawTapToStart();
    if(gameOver) drawGameOver();
    t += 1;
  }

  function drawBackground(){
    // transition fond entre prevTheme et currentTheme
    const mix = (a,b,k)=> `rgba(${Math.round(a[0]*(1-k)+b[0]*k)},${Math.round(a[1]*(1-k)+b[1]*k)},${Math.round(a[2]*(1-k)+b[2]*k)},1)`;
    const c2rgb = c=>{ const m=c.match(/#([0-9a-f]{6})/i); if(!m) return [15,26,38]; const n=parseInt(m[1],16); return [(n>>16)&255,(n>>8)&255,n&255]; };
    const bg1 = mix(c2rgb(prevTheme.bg1), c2rgb(currentTheme.bg1), themeTrans);
    const bg2 = mix(c2rgb(prevTheme.bg2), c2rgb(currentTheme.bg2), themeTrans);

    // gradient vertical
    const g=cx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,bg1); g.addColorStop(1,bg2);
    cx.fillStyle=g; cx.fillRect(0,0,W,H);

    // grille carrelage/texture
    cx.save();
    cx.strokeStyle = (themeTrans<1? prevTheme.grid : currentTheme.grid);
    cx.lineWidth = 1; const s = 32; for(let y = (-gridOffset % s); y < H; y += s){ cx.beginPath(); cx.moveTo(0,y); cx.lineTo(W,y); cx.stroke(); } for(let x = (-gridOffset % s); x < W; x += s){ cx.beginPath(); cx.moveTo(x,0); cx.lineTo(x,H); cx.stroke(); }
    cx.restore();
  }

  function drawFoamGround(){ const y0 = H - GROUND_H + 8; for(let i=0;i<3;i++){ const amp = 8 + i*4, h = 26 - i*6, off = (t*0.8 + i*30)%W; const col = i===0? 'rgba(232,245,255,0.9)' : i===1? 'rgba(207,232,255,0.8)' : 'rgba(207,232,255,0.6)'; cx.fillStyle = (currentTheme.id==='atelier' ? col.replace('255','245') : col); cx.beginPath(); cx.moveTo(0,y0+h); for(let x=0;x<=W;x+=8){ const y = y0 + Math.sin((x+off)/40)*amp; cx.lineTo(x,y); } cx.lineTo(W,H); cx.lineTo(0,H); cx.closePath(); cx.fill(); } }

  function drawBubbles(){ cx.save(); for(const b of bubbles){ cx.globalAlpha = b.alpha; const grad = cx.createRadialGradient(b.x-2,b.y-2,1,b.x,b.y,b.r); grad.addColorStop(0,'#ffffff'); grad.addColorStop(0.2,'#ffffffaa'); grad.addColorStop(1,'#a9d4ff10'); cx.fillStyle = grad; cx.beginPath(); cx.arc(b.x,b.y,b.r,0,Math.PI*2); cx.fill(); cx.globalAlpha = 1; } cx.restore(); }
  function drawLeaves(){ cx.save(); for(const f of leaves){ cx.translate(f.x,f.y); cx.rotate(f.rot); cx.fillStyle = (currentTheme.id==='atelier'? '#7ecb80' : '#6fbf73'); cx.beginPath(); cx.ellipse(0,0,f.w,f.h,0,0,Math.PI*2); cx.fill(); cx.setTransform(1,0,0,1,0,0);} cx.restore(); }
  function drawSteam(){ if(!currentTheme.fog) return; cx.save(); for(const s of steam){ cx.globalAlpha = s.a; const grad = cx.createRadialGradient(s.x,s.y,1,s.x,s.y,s.r); grad.addColorStop(0,'#ffffffaa'); grad.addColorStop(1,'#ffffff00'); cx.fillStyle = grad; cx.beginPath(); cx.arc(s.x,s.y,s.r,0,Math.PI*2); cx.fill(); } cx.globalAlpha=1; cx.restore(); }
  function drawConfetti(){ for(const c of confetti){ cx.save(); cx.translate(c.x,c.y); cx.rotate(c.r); cx.fillStyle = c.col; cx.fillRect(-2,-2,4,4); cx.restore(); }
  }

  const obstacleImg = OBSTACLE_IMG_URL ? (()=>{ const im=new Image(); im.src=OBSTACLE_IMG_URL; return im; })() : null;
  function drawPipes(){ for(const p of pipes){ if(obstacleImg && obstacleImg.complete){ const topH = Math.max(20, p.topH); cx.drawImage(obstacleImg, p.x, 0, PIPE_W, topH); const bottomH = Math.max(20, H - GROUND_H - p.bottomY); cx.drawImage(obstacleImg, p.x, p.bottomY, PIPE_W, bottomH); } else { const g1 = cx.createLinearGradient(0,0,0,H); g1.addColorStop(0,'#d5b48a'); g1.addColorStop(1,'#b78b5f'); cx.fillStyle = g1; roundRect(cx, p.x, 0, PIPE_W, p.topH, 12, true); roundRect(cx, p.x, p.bottomY, PIPE_W, H - GROUND_H - p.bottomY, 12, true); cx.fillStyle = '#9e7a52'; cx.fillRect(p.x, p.topH-8, PIPE_W, 8); cx.fillRect(p.x, p.bottomY, PIPE_W, 8); cx.fillStyle = '#ffffff3a'; cx.fillRect(p.x+8, Math.max(8,p.topH*0.35), PIPE_W-16, 12); cx.fillRect(p.x+8, p.bottomY + (H - GROUND_H - p.bottomY)*0.2, PIPE_W-16, 12); } } }

  function drawSoap(x,y,w,h,rot){ cx.save(); cx.translate(x,y); cx.rotate(rot); const r=12; const skin = SKINS.find(s=>s.id===skinId)||SKINS[0]; const g=cx.createLinearGradient(-w/2,-h/2,w/2,h/2); g.addColorStop(0,skin.c1); g.addColorStop(1,skin.c2); cx.fillStyle=g; roundRect(cx,-w/2,-h/2,w,h,r,true); cx.globalAlpha=.6; cx.fillStyle='#ffffff'; roundRect(cx,-w/2+6,-h/2+6,w-12,8,6,true); cx.globalAlpha=1; cx.fillStyle = '#0e1116'; cx.font = '800 8px system-ui'; cx.textAlign='center'; cx.textBaseline='middle'; cx.fillText('SAVON YVARD', 0, 2); cx.restore(); }

  function roundRect(ctx,x,y,w,h,r,fill){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); if(fill) ctx.fill(); else ctx.stroke(); }
  function drawTapToStart(){ cx.save(); cx.fillStyle='#ffffffcc'; cx.font='800 24px system-ui'; cx.textAlign='center'; cx.fillText('Appuie pour jouer', W/2, H*0.35); cx.font='14px system-ui'; cx.fillText('Espace / clic = saut', W/2, H*0.35 + 26); cx.restore(); }
  function drawGameOver(){ cx.save(); cx.fillStyle='#000000aa'; cx.fillRect(0,0,W,H); cx.fillStyle='#fff'; cx.textAlign='center'; cx.font='800 36px system-ui'; cx.fillText('Perdu !', W/2, H/2 - 30); cx.font='16px system-ui'; cx.fillText('Cliquer ou espace pour rejouer', W/2, H/2 + 6); cx.restore(); }

  // ====== Badges & confettis ======
  const BADGES=[{s:10,n:'Apprenti Mousse'},{s:25,n:'Ma√Ætre Savonnier'},{s:50,n:'L√©gende de la Mousse'}];
  let unlocked = JSON.parse(localStorage.getItem('flappyBadges')||'{}');
  function checkBadges(sc){ for(const b of BADGES){ if(sc===b.s && !unlocked[b.s]){ unlocked[b.s]=true; localStorage.setItem('flappyBadges', JSON.stringify(unlocked)); showToast('Badge d√©bloqu√©: '+b.n); spawnConfetti(); } } }
  function spawnConfetti(){ for(let i=0;i<60;i++){ confetti.push({ x:W/2+rand(-80,80), y:H*0.3+rand(-20,20), vx:rand(-1,1), vy:rand(-2,-0.5), life:rand(18,30), r:rand(0,6), col: 'hsl('+Math.floor(rand(0,360))+',80%,60%)' }); } }

  // ====== Identit√© & Onboarding ======
  function openIdentityModal(){
    pseudoInput.value = localStorage.getItem('pseudo')||'';
    emailInput.value = localStorage.getItem('email')||'';
    optinInput.checked = localStorage.getItem('optin_email')==='1';
    idModal.classList.add('open'); idModal.setAttribute('aria-hidden','false');
  }
  function closeIdentityModal(){ idModal.classList.remove('open'); idModal.setAttribute('aria-hidden','true'); }
  function saveIdentity(){
    const pseudo=(pseudoInput.value||'').trim();
    const email=(emailInput.value||'').trim();
    const optin=!!optinInput.checked;
    // autocompl√©tion du pseudo si e-mail rempli
    if(email && !pseudo){ const sug = email.split('@')[0].slice(0,24); pseudoInput.value = sug; }

    // consentement OBLIGATOIRE pour cr√©er un compte
    if(!(pseudo && email && optin)){
      showToast('Pour cr√©er un compte, renseigne pseudo + e‚Äëmail et coche la case.');
      return false; // pas d‚Äôenregistrement -> reste invit√©
    }
    localStorage.setItem('pseudo', pseudo);
    localStorage.setItem('email', email);
    localStorage.setItem('optin_email', optin ? '1' : '0');
    showToast('Compte enregistr√©');
    return true;
  }
  emailInput.addEventListener('input', ()=>{ if(!pseudoInput.value){ const v=emailInput.value; const sug=v.includes('@')? v.split('@')[0] : v; pseudoInput.value=sug.slice(0,24); }});
  idSave.addEventListener('click', ()=>{ saveIdentity(); });
  idStart.addEventListener('click', ()=>{
    const ok = saveIdentity();
    if(!ok){
      // Mode invit√© : on ne stocke rien (ou on garde seulement pseudo invit√© non nominatif)
      localStorage.setItem('pseudo', 'Invit√©');
      localStorage.removeItem('email');
      localStorage.setItem('optin_email','0');
    }
    localStorage.setItem('flappySavonOnboarded','1');
    closeIdentityModal(); showToast('Bon jeu !');
  });

  async function sha256(str){ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

  async function postScore(){
    const pseudo=(localStorage.getItem('pseudo')||'Invit√©').trim()||'Invit√©';
    const email=(localStorage.getItem('email')||'').trim();
    const optin = localStorage.getItem('optin_email')==='1';
    const elapsed = Math.max(1, Math.round((performance.now()-gameStartMs)/1000));
    const hash = await sha256([pseudo,email,score,elapsed,sessionSeed].join('|'));
    try{ await fetch(ENDPOINT_SCORE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ pseudo, email, optin_email: optin, score, points: totalPoints, best, elapsed, seed: sessionSeed, hash, badges: Object.keys(unlocked).map(k=>Number(k)), ts: new Date().toISOString(), ua: navigator.userAgent }) }); }catch(e){}
  }

  async function loadLeaderboard(){ leaderRows.innerHTML = '<div class="muted">Chargement‚Ä¶</div>'; leaderMeta.textContent = ''; try{ const res = await fetch(ENDPOINT_LEADER, { cache:'no-store' }); if(!res.ok) throw new Error('HTTP '+res.status); const data = await res.json(); lastLeaderboard = data; renderLeaderboard(Array.isArray(data)?data.slice(0,10):[]); leaderMeta.textContent = 'MAJ: '+ new Date().toLocaleString(); const r = computeRank(data); if(r) setLiveRank(r, !localStorage.getItem('email')); return data; }catch(e){ leaderRows.innerHTML = '<div class="muted">Impossible de charger le classement.</div>'; return null; } }

  function renderLeaderboard(rows){ leaderRows.innerHTML = ''; if(!rows.length){ leaderRows.innerHTML = '<div class="muted">Aucun score pour le moment.</div>'; return; } rows.forEach((r,i)=>{ const div = document.createElement('div'); const medal = i===0?'ü•á': i===1?'ü•à': i===2?'ü•â': ''; div.className = 'lb-row'+(i===0?' top1':'' ); div.innerHTML = '<div class="medal">'+medal+'</div><div>'+escapeHtml(r.pseudo||'Anonyme')+'</div><div>'+(r.best ?? r.score ?? 0)+'</div>'; leaderRows.appendChild(div); }); }

  function computeRank(rows){ try{ const email=(localStorage.getItem('email')||'').toLowerCase(); if(!rows||!rows.length) return null; if(email){ const idx = rows.findIndex(r=> (String(r.email||'')).toLowerCase()===email ); if(idx>=0) return idx+1; } const meBest = Number(localStorage.getItem('flappySavonBest')||0); let rank = 1; for(const r of rows){ const b = Number(r.best ?? r.score ?? 0); if(b>meBest) rank++; } return rank; }catch{return null;} }

  function adjustAmbientByTheme(th){
    const targetLeaves = th.leaves;
    while(leaves.length < targetLeaves) spawnLeaf(W+rand(0,200));
    while(leaves.length > targetLeaves) leaves.pop();
    if(Math.random()<0.3*th.bubbleMul) spawnBubble(rand(0,W), H - GROUND_H - rand(10,90));
  }

  function spawnSteam(){ steam.push({ x:rand(20,W-20), y:H - GROUND_H - rand(20,100), r:rand(8,18), v:rand(0.2,0.6), a:rand(0.08,0.18), seed:Math.random() }); }

  const escapeHtml=s=> String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

  async function shareScore(){ const url = location.href; const txt = 'Je viens de faire '+score+' sur Flappy Savon Yvard ! '+url; if(navigator.share){ try{ await navigator.share({ title:'Flappy Savon', text:txt, url }); }catch{} } else { try{ await navigator.clipboard.writeText(txt); showToast('Lien copi√©'); }catch{ showToast('Impossible de copier'); } } }

  // ====== Compte √† rebours concours ======
  function tickCountdown(){ try{ const end = new Date(CONTEST_END); const now = new Date(); let diff = Math.max(0, end - now); const d = Math.floor(diff/86400000); diff%=86400000; const h=Math.floor(diff/3600000); diff%=3600000; const m=Math.floor(diff/60000); diff%=60000; const s=Math.floor(diff/1000); countdownEl.textContent = (end>now) ? ('Fin dans '+d+'j '+h+'h '+m+'m '+s+'s') : 'Concours termin√©'; }catch(e){ countdownEl.textContent=''; } }
  setInterval(tickCountdown,1000); tickCountdown();

  // ====== Onboarding au tout premier lancement uniquement ======
  function maybeShowOnboarding(){
    const hasId = !!(localStorage.getItem('pseudo') && localStorage.getItem('email') && localStorage.getItem('optin_email')==='1');
    const done = localStorage.getItem('flappySavonOnboarded')==='1';
    if(!hasId && !done){ openIdentityModal(); }
  }

  // D√©marrage
  function spawnLeaf(x, returning){ const l={ x, y: rand(40, H-GROUND_H-120), w: rand(8,14), h: rand(3,6), vx: rand(0.4,1.1), vy: rand(-0.2,0.2), rot: rand(-0.3,0.3) }; if(returning) return l; else { leaves.push(l); return l; } }
  function spawnBubble(x,y){ bubbles.push({ x, y, r: rand(3,9), vy: rand(0.6,1.6), alpha: rand(0.25,0.6) }); }
  function splash(x,y){ for(let i=0;i<5;i++) spawnBubble(x+rand(-10,10), y+rand(-8,8)); }

  reset(); requestAnimationFrame(loop);
  maybeShowOnboarding();
  loadLeaderboard();
  setInterval(loadLeaderboard, 30000);

  // ====== Tests (dev) ======
  (function runTests(){
    if(!/test=1/.test(location.search)) return;
    const assert = (name, cond) => console.log((cond?'‚úÖ ':'‚ùå ')+name);
    assert('AABB overlap', intersectAABB(0,0,10,10, 5,5,15,15) === true);
    assert('AABB disjoint', intersectAABB(0,0,10,10, 11,11,20,20) === false);
    assert('escapeHtml', escapeHtml('<&>"\'') === '&lt;&amp;&gt;&quot;&#39;');
    const rows = [{email:'a@b.c', best:30},{email:'x@y.z', best:20}];
    localStorage.setItem('email','x@y.z'); localStorage.setItem('flappySavonBest','20');
    assert('computeRank exact match', computeRank(rows) === 2);
    localStorage.setItem('email','none@none'); localStorage.setItem('flappySavonBest','25');
    assert('computeRank estimate', computeRank(rows) === 2);
    assert('tickCountdown exists', typeof tickCountdown === 'function');
    console.log('Tests termin√©s.');
  })();
  </script>
</body>
</html>
